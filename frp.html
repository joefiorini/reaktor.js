<!doctype html>
<html>
  <head>
    <title>Intro to FRP</title>
    <link rel="stylesheet" href="normalize.css">
    <style type="text/css">
      .mbb { margin-bottom: 2em; }
      .mbs { margin-bottom: 1em; }
      .mbn { margin-bottom: 0; }
    </style>
  </head>
  <body>

    <h1>FRP</h1>
    <label>
      Enter a US zip code to search for: <br>
      <input name="zip-code" id="zip-code" class="mbs"><br>
      <button id="search">Search</button>
    </label>
    <p id="result"></p>

    <script type="text/javascript" src="promise.js"></script>
    <script type="text/javascript" src="sprintf.js"></script>
    <script type="text/javascript">

      function extract(value){
        return value();
      }

      function Behavior(type, selector){
        var element = document.querySelector(selector),
            p = new promise.Promise(),
            origThen = p.then,
            bindEvent = function(){
              element.addEventListener(type, function(){
                p.done();
              });
            };

        p.then = function(fn){
          origThen.call(p, function(){
            fn.apply(this, arguments);
            Behavior(type, selector).then(fn);
          });
        }

        bindEvent();

        return p;
      }

      function Value(selector){
        var element = document.querySelector(selector),
            _value,
            value = function(){
              return _value;
            }
        element.addEventListener("change", function(){
          _value = this.value;
        });
        return value;
      }

      var click = Behavior("click", "#search"),
          zipCode = Value("#zip-code"),
          template = "%s is in %s, %s";

      click.then(function(){
        promise.get("http://zip.elevenbasetwo.com/v2/US/" + extract(zipCode)).then(function(error, result){
          result = JSON.parse(result);
          var message =
           sprintf(template, extract(zipCode), result.city, result.state);
          document.querySelector("#result").innerText = message;
        });
      });
    </script>

  </body>
</html>
